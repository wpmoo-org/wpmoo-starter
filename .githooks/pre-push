#!/usr/bin/env bash
set -euo pipefail

echo "WPMoo Starter pre-push: composer validate, PHPStan, PHPUnit"

SKIP_PHPSTAN=${SKIP_PHPSTAN:-0}
SKIP_TESTS=${SKIP_TESTS:-0}

if command -v composer >/dev/null 2>&1 && [ -f composer.json ]; then
  composer validate --strict --no-check-lock --ansi || exit 1
fi

if [ "$SKIP_PHPSTAN" != "1" ] && [ -x vendor/bin/phpstan ] \
   && { [ -f phpstan.neon ] || [ -f phpstan.neon.dist ]; }; then
  echo "→ PHPStan (full project)"
  vendor/bin/phpstan analyse --no-progress --memory-limit=512M || exit 1
fi

if [ "$SKIP_TESTS" != "1" ] && [ -x vendor/bin/phpunit ] \
   && { [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; }; then
  echo "→ PHPUnit (full suite)"
  vendor/bin/phpunit -v || exit 1
fi

echo "✔ Pre-push checks passed"
exit 0

