name: Deploy to WordPress.org

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_DIR: ${{ github.event.repository.name }}
      COMPOSER_ROOT_VERSION: dev-main
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP 7.4 (Composer v2)
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"
          extensions: zip
          tools: composer:v2
          coverage: none
          ini-values: memory_limit=-1

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Show tool versions
        run: |
          php -v
          composer --version
          node -v
          npm -v

      - name: Install Composer dependencies (with dev)
        run: composer install --no-interaction --prefer-dist --ansi

      - name: Update "Tested up to" to latest WP
        run: |
          LATEST=$(php -r 'echo json_decode(file_get_contents("https://api.wordpress.org/core/version-check/1.7/"), true)["offers"][0]["current"];')
          echo "Latest WP: $LATEST"
          sed -i.bak -E "s/^(Tested up to:).*/\\1 ${LATEST}/" readme.txt && rm -f readme.txt.bak

      - name: Build distribution directory (WPMoo CLI)
        run: php vendor/bin/moo deploy --wp

      - name: Plugin Check (WordPress.org)
        if: ${{ github.event.release.target_commitish == 'main' }}
        uses: WordPress/plugin-check-action@v1.1.3
        with:
          build-dir: ../dist/${{ env.PLUGIN_DIR }}
          strict: true
          ignore-codes: trademarked_term

      - name: Deploy to WordPress.org (SVN)
        uses: 10up/action-wordpress-plugin-deploy@2.3.0
        env:
          SLUG: ${{ github.event.repository.name }}
          BUILD_DIR: ../dist/${{ env.PLUGIN_DIR }}
          SVN_USERNAME: ${{ secrets.WPORG_USERNAME }}
          SVN_PASSWORD: ${{ secrets.WPORG_PASSWORD }}
